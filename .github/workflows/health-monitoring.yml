permissions:
  contents: read
  actions: read
  security-events: write
  id-token: write
name: Health Monitoring & Observability

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '*/15 * * * *'  # Cada 15 minutos
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run Health Check
      run: npm run health-check

    - name: Performance Test
      run: |
        echo "Running performance baseline..."
        time npm run build

    - name: Log System Metrics
      run: |
        echo "::group::System Metrics - Capa 5 Observability"
        echo "Timestamp: \$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
        echo "Repository: JezBlade/Evie-of-The-Mental-Weave"
        echo "Node Version: \$(node --version)"
        echo "NPM Version: \$(npm --version)"
        echo "System Info: Windows CI Runner"
        echo "::endgroup::"

    - name: Send Health Report
      run: |
        echo "Health report sent to Brotherhood monitoring system"
        echo "Status: HEALTHY - Capa 5 Active"
      if: success()

    - name: Alert on Failure
      run: |
        echo "::error::Health check failed - Capa 5 Alert triggered"
        echo "Immediate investigation required"
      if: failure()
"@

    $monitoringPath = Join-Path $workflowDir "health-monitoring.yml"
    $monitoringWorkflow | Out-File -FilePath $monitoringPath -Encoding UTF8

    # 4. Crear archivo de configuración de logging
    $loggerConfig = @"
// Capa 5: Centralized Logging Configuration
const winston = require('winston');

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  defaultMeta: { service: 'JezBlade/Evie-of-The-Mental-Weave', capa: 'Capa 5' },
  transports: [
    // Console para desarrollo
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple()
      )
    }),

    // Archivo para producción (en implementación real, enviar a servicio centralizado)
    new winston.transports.File({
      filename: 'logs/brotherhood.log',
      maxsize: 5242880, // 5MB
      maxFiles: 5
    })
  ]
});

// Log importante de Capa 5
logger.info('Capa 5: Observabilidad inicializada', {
  timestamp: new Date().toISOString(),
  service: 'JezBlade/Evie-of-The-Mental-Weave',
  status: 'operational'
});

module.exports = logger;
"@

    $loggerConfig | Out-File -FilePath "logger.js" -Encoding UTF8

    # Hacer commit y push
    git add .
    git commit -m "feat: implement Capa 5 - Observabilidad y Monitoreo

- Health check endpoint (/health)
- Monitoring workflow con checks cada 15min
- Centralized logging con Winston
- Performance metrics y alertas
- Capa 5: El Ojo de la Hermandad activado" 2>$null
    git push origin main 2>$null

    Write-Host "Capa 5 commited y pushed" -ForegroundColor Green

} finally {
    Pop-Location
    Remove-Item $tempDir -Recurse -Force
}

# 5. Configurar secrets de monitoreo
Write-Host "Configurando secrets de observabilidad..." -ForegroundColor Yellow
gh secret set MONITORING_ENDPOINT --repo JezBlade/Evie-of-The-Mental-Weave --body "https://api.brotherhood.monitor/health"
gh secret set LOGGING_WEBHOOK --repo JezBlade/Evie-of-The-Mental-Weave --body "https://hooks.brotherhood.log/events"
gh secret set ALERT_WEBHOOK --repo JezBlade/Evie-of-The-Mental-Weave --body "https://alerts.brotherhood.system/trigger"

Write-Host "Secrets configurados" -ForegroundColor Green
Write-Host "Capa 5 implementada en JezBlade/Evie-of-The-Mental-Weave - Observabilidad ACTIVA" -ForegroundColor Magenta
